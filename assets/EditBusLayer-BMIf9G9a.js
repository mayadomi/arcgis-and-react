const __vite__fileDeps=["assets/deleteForwardEdits-D4pDtE-0.js","assets/index-BdlI2FVT.js","assets/index-DQMU5mn_.css","assets/utils-nisnNviQ.js","assets/DeleteForwardEditsParameters-CD31Tevh.js"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{U as R,$,bO as U,f as H,g as T,bD as x,B as p}from"./index-BdlI2FVT.js";import{o as k}from"./uuid-fwrPAdZb.js";const P=k(),j=new Map,w=new Map;async function N(e,s,d){if(!e||!d)return!1;if(!s)return!0;const n=new URL(e).host;let t=j.get(n);if(!t){const r=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");t=(await R(r,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}return t===s}async function z(e,s,d=!1){var r,a;if(!e||!s)return!0;const n=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),t=(r=w.get(n))==null?void 0:r.entries();if(t){for(const[l,c]of t)if(c.name===s){const u=!((a=c.stack)!=null&&a.hasForwardEdits());if(!u&&d){const[{deleteForwardEdits:m},{default:h}]=await Promise.all([$(()=>import("./deleteForwardEdits-D4pDtE-0.js"),__vite__mapDeps([0,1,2,3])),$(()=>import("./DeleteForwardEditsParameters-CD31Tevh.js"),__vite__mapDeps([4,1,2]))]);return m(n,l,new h({sessionId:P,moment:c.moment}))}return u}}return!0}function D(e,s){var t;if(!e)return!1;const d=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),n=(t=w.get(d))==null?void 0:t.entries();if(n){for(const[r,a]of n)if(a.name===s)return a.lockType==="edit"}return!1}const g=new U.EventEmitter;function O(e){return g.on("apply-edits",new WeakRef(e))}function B(e){return g.on("update-moment",new WeakRef(e))}function C(e,s,d=null,n=!1){const t=x();return n=s==null||n,g.emit("apply-edits",{serviceUrl:e,layerId:s,gdbVersion:d,mayReceiveServiceEdits:n,result:t.promise}),t}const E="esri.layers.mixins.EditBusLayer",V=Symbol(E);function G(e){return e!=null&&typeof e=="object"&&V in e}function f(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function F(e,s,d){const n=new URL(e).host,t=j.get(n),r=a=>!a||a===t;return r(s)&&r(d)||s===d}const J=e=>{var s;let d=class extends e{constructor(...n){super(...n),this[s]=!0,this._applyEditsHandler=t=>{const{serviceUrl:r,layerId:a,gdbVersion:l,mayReceiveServiceEdits:c,result:u}=t,m=r===this.url,h=a!=null&&this.layerId!=null&&a===this.layerId,A=f(this),S=f(this)&&F(r,l,this.gdbVersion);if(!m||A&&!S||!h&&!c)return;const L=u.then(i=>{var y;if(h&&(i.addedFeatures.length||i.updatedFeatures.length||i.deletedFeatures.length||i.addedAttachments.length||i.updatedAttachments.length||i.deletedAttachments.length))return this.emit("edits",p(i)),i;const I=(y=i.editedFeatures)==null?void 0:y.find(({layerId:b})=>b===this.layerId);if(I){const{adds:b,updates:M,deletes:v}=I.editedFeatures,_={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:b?b.map(({attributes:o})=>({objectId:this.objectIdField&&o[this.objectIdField],globalId:this.globalIdField&&o[this.globalIdField]})):[],deletedFeatures:v?v.map(({attributes:o})=>({objectId:this.objectIdField&&o[this.objectIdField],globalId:this.globalIdField&&o[this.globalIdField]})):[],updatedFeatures:M?M.map(({current:{attributes:o}})=>({objectId:this.objectIdField&&o[this.objectIdField],globalId:this.globalIdField&&o[this.globalIdField]})):[],editedFeatures:p(i.editedFeatures),exceededTransferLimit:!1,historicMoment:p(i.historicMoment)};return this.emit("edits",_),_}return{edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:p(i.editedFeatures),exceededTransferLimit:!1,historicMoment:p(i.historicMoment)}}).then(i=>("historicMoment"in this&&this.historicMoment!==i.historicMoment&&D(r,l)&&(this.historicMoment=i.historicMoment),i));this.emit("apply-edits",{result:L})},this._updateMomentHandler=t=>{const{serviceUrl:r,gdbVersion:a,moment:l}=t,c=r===this.url,u=f(this),m=f(this)&&F(r,a,this.gdbVersion),h=f(this)&&!F(r,this.gdbVersion,null);c&&u&&m&&h&&"historicMoment"in this&&this.historicMoment!==l&&(this.historicMoment=l)},this.when().then(()=>{this.addHandles(O(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(B(this._updateMomentHandler))},()=>{})}};return s=V,d=H([T(E)],d),d};export{J as F,N as a,D as c,C as h,z as i,G as p,P as t};
