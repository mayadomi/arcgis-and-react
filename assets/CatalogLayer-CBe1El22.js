import{V as w,aD as v,e as _,b as $,f as o,y as s,g as c,Q as j,l as T,a9 as F,a1 as S,s as b,I as x,bH as P,U as R}from"./index-BdlI2FVT.js";import{m as h}from"./MultiOriginJSONSupport-BP0y40tB.js";import{b as u}from"./Layer-CcYrbAYa.js";import{e as O}from"./LRUCache-CZ2xYNgP.js";import{n as f}from"./BlendLayer-CCBI54kf.js";import{t as g}from"./ScaleRangeLayer-B24df4gL.js";import{g as L,m as V,a as C,y as Q}from"./commonProperties-DDhb4E0s.js";import{a as E}from"./lazyLayerLoader-B2GRwTGz.js";import{a as q,c as B}from"./OrderedLayer-DupPBghv.js";import D from"./PortalItem-D_imZ4F9.js";import{T as U}from"./utils-DnvSpbGV.js";import"./UniqueValueRenderer-7uqoe5qH.js";import{a as G}from"./jsonUtils-BIPVkO8e.js";import{p as J}from"./FeatureEffectLayer-BThrs5AW.js";import{C as N}from"./LabelClass-1tjVzjjL.js";import{i as A}from"./labelingInfo-Dio46WYR.js";import{p as M}from"./popupUtils-fsRna_vH.js";import H from"./FeatureLayerSource-Caqs-PkU.js";import{o as k}from"./clientSideDefaults-BKblCmxj.js";import{i as K}from"./APIKeyMixin-Cr6SPtKV.js";import{l as z}from"./ArcGISService-B0MFY8rl.js";import{e as W}from"./CustomParametersMixin-B15dM9ne.js";import{D as X}from"./FeatureLayerBase-DLhTJN_m.js";import{u as Y}from"./OperationalLayer-BvVMmVx0.js";import{j as Z}from"./PortalLayer-Ce7CgRR0.js";import{f as ee}from"./RefreshableLayer-DgZkcGPN.js";import{f as te}from"./TemporalLayer-BLPwEJby.js";import{Q as re}from"./featureLayerUtils-ecDuVTtZ.js";import{s as oe}from"./fieldProperties-BRDCz7QD.js";import{e as ie}from"./versionUtils-DcsImNVm.js";import{b as y}from"./Query-C67dhdyp.js";import"./mat4f32-DcsiF_Rp.js";import"./mat4-CSxAPr-6.js";import"./ClassBreaksDefinition-CrXWJYKW.js";import"./ColorStop-BjodVbhP.js";import"./diffUtils-Cvmld_nE.js";import"./colorRamps-CSdC0saB.js";import"./compilerUtils-vO2blZnn.js";import"./styleUtils-DHuQZmH8.js";import"./layerUtils-C0ByrsCg.js";import"./Version-Cllr3DhQ.js";import"./FieldsIndex-BZm6eFTZ.js";import"./UnknownTimeZone-BLIgHyqR.js";import"./colorUtils-K6WWckc_.js";import"./vec42-DpHkGCNS.js";import"./vec4f64-CCf6w8sj.js";import"./heatmapUtils-Xd5ASPFI.js";import"./defaults-xH7YtUqE.js";import"./defaultsJSON-CHAaurhX.js";import"./uuid-fwrPAdZb.js";import"./meshVertexSpaceUtils-C9bNTGWC.js";import"./MeshLocalVertexSpace-CqEI9wro.js";import"./vec3-o6_Ds2WY.js";import"./External-BMGwWfm6.js";import"./infoFor3D-DsOdlPuA.js";import"./projection-NmY8Pkrx.js";import"./editingSupport-CW-KmxyI.js";import"./normalizeUtils-Cik6ve5l.js";import"./normalizeUtilsCommon-Cpq7p5az.js";import"./utils-nisnNviQ.js";import"./EditBusLayer-BMIf9G9a.js";import"./QueryTask-C_Fy3dex.js";import"./executeForIds-DOReORur.js";import"./query-gDdM8KJG.js";import"./pbfQueryUtils-2_EOj78-.js";import"./pbf-vQQtfZjw.js";import"./OptimizedGeometry-CQuTPb9g.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./queryZScale-DxngEzoS.js";import"./executeQueryJSON-DQvHyqrp.js";import"./FeatureSet-BVXviJDD.js";import"./Field-CcwrtZjp.js";import"./fieldType-CHp3lv4g.js";import"./executeQueryPBF-u_spJMXj.js";import"./featureConversionUtils-DuXJe-nV.js";import"./portalItemUtils-CCKlXC6h.js";import"./editsZScale-Csrkyd4Q.js";import"./QueryEngineCapabilities-CTDe3LlQ.js";import"./AttachmentQuery-CmVGfcPE.js";import"./RelationshipQuery-BllPoPyE.js";import"./HeightModelInfo-B2Y4TPgv.js";import"./LayerFloorInfo-CAYEpzeH.js";import"./serviceCapabilitiesUtils-CcOSoojL.js";import"./TimeInfo-BBnCNS7R.js";class se{constructor(t,r){this.objectId=t,this.itemSource=r,this.count=0,this.layer=null,this.sortValue=void 0}}const d=new O(20,e=>e.destroy());let l=class extends g(f(h(u))){constructor(e){super(e),this._oidToReference=new Map,this._layerToReference=new Map,this._portals=new Map,this.layers=new w,this.maximumVisibleSublayers=10,this.opacity=1,this.title="Layers In View",this.type="catalog-dynamic-group",this.visible=!0}load(e){return this.addResolvingPromise(this.parent.load()),Promise.resolve(this)}get _orderBy(){var e;return((e=this.parent.orderBy)==null?void 0:e.find(t=>!t.valueExpression&&t.field))??new q({field:this.parent.objectIdField})}get _referenceComparator(){const e=this._orderBy,t=this.parent.fieldsIndex.get(e.field),r=U(t==null?void 0:t.toJSON().type,e.order==="descending");return(i,a)=>r(i.sortValue,a.sortValue)||i.objectId-i.objectId}acquireLayer(e){const t=e.getObjectId(),r=v(this._oidToReference,t,()=>this._createLayerReference(e));return r.count++,_(()=>{r.count--,r.count||this._disposeLayerReference(r)})}_createLayerReference(e){const t=e.getObjectId(),r=e.getAttribute(this.parent.itemSourceField),i=new se(t,r);if(d.get(r))return this._addLayer(d.pop(r),i,e),i;let a;try{a=JSON.parse(r)}catch(m){return $.getLogger(this).error(m),i}return this._createLayer(a).then(m=>{this.destroyed||i.count===0?(d.get(r)||d.put(i.itemSource,m),i.layer=null):this._addLayer(m,i,e)}).catch(()=>{}),i}_addLayer(e,t,r){this._layerToReference.set(e,t),t.sortValue=r.getAttribute(this._orderBy.field),t.layer=e,e.parent=this,this.layers.add(e),this.layers.sort((i,a)=>this._referenceComparator(this._layerToReference.get(i),this._layerToReference.get(a)))}_disposeLayerReference(e){e.layer&&(this._layerToReference.delete(e.layer),this.layers.remove(e.layer),d.put(e.itemSource,e.layer)),this._oidToReference.delete(e.objectId)}async _createLayer(e){if(!pe(e))return new(await E.UnsupportedLayer());const{itemId:t,portalUrl:r}=e,i=v(this._portals,r,()=>new j({url:r}));return u.fromPortalItem(new D({id:t,portal:i}))}};o([s()],l.prototype,"_orderBy",null),o([s()],l.prototype,"_referenceComparator",null),o([s({readOnly:!0})],l.prototype,"layers",void 0),o([s()],l.prototype,"maximumVisibleSublayers",void 0),o([s(L)],l.prototype,"opacity",void 0),o([s({type:String,json:{name:"title",write:!0}})],l.prototype,"title",void 0),o([s({json:{read:!1}})],l.prototype,"type",void 0),o([s({type:Boolean,json:{name:"visibility",write:!0}})],l.prototype,"visible",void 0),l=o([c("esri.layers.catalog.CatalogDynamicGroupLayer")],l);const ae=l;function pe(e){return typeof e=="object"&&e!=null&&"itemId"in e&&"portalUrl"in e}let n=class extends g(J(f(h(u)))){constructor(e){super(e),this.labelingInfo=null,this.labelsVisible=!0,this.legendEnabled=!0,this.opacity=1,this.popupEnabled=!0,this.popupTemplate=null,this.renderer=null,this.type="catalog-footprint",this.visible=!0}load(e){return this.addResolvingPromise(this.parent.load()),Promise.resolve(this)}get defaultPopupTemplate(){return this.createPopupTemplate()}get fields(){return this.parent.fields}get fieldsIndex(){return this.parent.fieldsIndex}get geometryType(){return this.parent.geometryType}get objectIdField(){return this.parent.objectIdField}get orderBy(){return this.parent.orderBy}createPopupTemplate(e){const t={fields:this.parent.fields,objectIdField:this.parent.objectIdField,title:this.title};return M(t,e)}createQuery(){return this.parent.createQuery()}queryFeatures(e,t){return this.parent.queryFeatures(e,t)}};o([s({readOnly:!0})],n.prototype,"defaultPopupTemplate",null),o([s({type:[N],json:{name:"layerDefinition.drawingInfo.labelingInfo",read:A,write:!0}})],n.prototype,"labelingInfo",void 0),o([s(V)],n.prototype,"labelsVisible",void 0),o([s(C)],n.prototype,"legendEnabled",void 0),o([s(L)],n.prototype,"opacity",void 0),o([s(Q)],n.prototype,"popupEnabled",void 0),o([s({type:T,json:{name:"popupInfo",write:!0}})],n.prototype,"popupTemplate",void 0),o([s({types:G,json:{name:"layerDefinition.drawingInfo.renderer"}})],n.prototype,"renderer",void 0),o([s({json:{read:!1}})],n.prototype,"type",void 0),o([s({type:Boolean,json:{name:"visibility",write:!0}})],n.prototype,"visible",void 0),n=o([c("esri.layers.catalog.CatalogFootprintLayer")],n);const ne=n,le="esri.layers.CatalogLayer",I=oe();let p=class extends X(f(B(te(g(ee(z(Y(Z(h(W(K(F(u))))))))))))){constructor(e){super(e),this.dynamicGroupLayer=new ae({parent:this}),this.fields=null,this.fieldsIndex=null,this.footprintLayer=new ne({parent:this}),this.itemSourceField="cd_itemsource",this.itemTypeField="cd_itemtype",this.layers=new w([this.dynamicGroupLayer,this.footprintLayer]),this.source=new H({layer:this}),this.type="catalog"}load(e){const t=e!=null?e.signal:null,r=this.loadFromPortal({supportedTypes:["Feature Service"]},e).catch(S).then(async()=>{var i;if(!this.url)throw new b("catalog-layer:missing-url","Catalog layer must be created with a url");if(this.url&&this.layerId==null){const a=await this._fetchFirstValidLayerId(t);if(a==null)throw new b("catalog-layer:missing-layerId","There is no Catalog Layer in the service",{service:this.url});this.layerId=a}await this.source.load(),this.source.sourceJSON&&(this.sourceJSON=this.source.sourceJSON,this.read(this.source.sourceJSON,{origin:"service",portalItem:this.portalItem,portal:(i=this.portalItem)==null?void 0:i.portal,url:this.parsedUrl}))}).then(()=>re(this,"load",e));return this.addResolvingPromise(r),Promise.resolve(this)}get createQueryVersion(){return this.commitProperty("definitionExpression"),this.commitProperty("timeExtent"),this.commitProperty("timeOffset"),this.commitProperty("geometryType"),this.commitProperty("capabilities"),(this._get("createQueryVersion")??0)+1}get parsedUrl(){const e=x(this.url);return e!=null&&this.layerId!=null&&(e.path=P(e.path,this.layerId.toString())),e}createQuery(){var a;const e=new y,t=(a=this.capabilities)==null?void 0:a.query;e.returnGeometry=!0,t&&(e.compactGeometryEnabled=t.supportsCompactGeometry,e.defaultSpatialReferenceEnabled=t.supportsDefaultSpatialReference),e.outFields=["*"];const{timeOffset:r,timeExtent:i}=this;return e.timeExtent=r!=null&&i!=null?i.offset(-r.value,r.unit):i||null,e}getField(e){return this.fieldsIndex.get(e)}getFieldDomain(e,t){var r;return(r=this.fieldsIndex.get(e))==null?void 0:r.domain}async queryFeatures(e,t){const r=await this.load(),i=await r.source.queryFeatures(y.from(e)??r.createQuery(),t);if(i!=null&&i.features)for(const a of i.features)a.layer=a.sourceLayer=r.footprintLayer;return i}async queryObjectIds(e,t){return(await this.load()).source.queryObjectIds(y.from(e)??this.createQuery(),t)}async queryFeatureCount(e,t){return(await this.load()).source.queryFeatureCount(y.from(e)??this.createQuery(),t)}async queryExtent(e,t){return(await this.load()).source.queryExtent(y.from(e)??this.createQuery(),t)}serviceSupportsSpatialReference(e){return this.loaded&&ie(this,e)}read(e,t){super.read(e,t);let r=e.footprintLayer;r||(t==null?void 0:t.origin)!=="service"||(r={layerDefinition:{drawingInfo:k(e.geometryType)}}),this.footprintLayer.read(r,t)}_fetchFirstValidLayerId(e){return R(this.url,{query:{f:"json",...this.customParameters,token:this.apiKey},responseType:"json",signal:e}).then(t=>{var i;const r=t.data;if(r)return Array.isArray(r.layers)?(i=r.layers.find(a=>a.type==="Catalog Layer"))==null?void 0:i.id:void 0})}};o([s({readOnly:!0})],p.prototype,"createQueryVersion",null),o([s({...I.fields,json:{origins:{service:{name:"fields"}}}})],p.prototype,"fields",void 0),o([s(I.fieldsIndex)],p.prototype,"fieldsIndex",void 0),o([s({json:{read:!1,write:!1}})],p.prototype,"footprintLayer",void 0),o([s()],p.prototype,"itemSourceField",void 0),o([s()],p.prototype,"itemTypeField",void 0),o([s()],p.prototype,"layers",void 0),o([s({value:"CatalogLayer",type:["CatalogLayer"]})],p.prototype,"operationalLayerType",void 0),o([s()],p.prototype,"outFields",void 0),o([s({readOnly:!0})],p.prototype,"parsedUrl",null),o([s()],p.prototype,"source",void 0),o([s({json:{read:!1}})],p.prototype,"type",void 0),p=o([c(le)],p);const Ut=p;export{Ut as default};
