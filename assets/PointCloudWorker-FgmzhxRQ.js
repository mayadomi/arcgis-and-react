import{dH as D,q as S,ad as v,dI as C}from"./index-BdlI2FVT.js";import{O as x}from"./quat-nUUgiqFL.js";import{e as k}from"./quatf64-Bdb9ZJJK.js";import{t as A,n as w}from"./vec3f32-nZdmKIgz.js";import{n as F}from"./projection-NmY8Pkrx.js";import{a as R,b as U,d as B}from"./PointCloudUniqueValueRenderer-b6zas1aU.js";import{w as J,l as N,c as V,I as q}from"./I3SBinaryReader-Bz4f2dgD.js";import{O as T}from"./orientedBoundingBox-Ds_j80lb.js";import"./mat3f64-q3fE-ZOt.js";import"./vec42-DpHkGCNS.js";import"./ColorStop-BjodVbhP.js";import"./VertexAttribute-BlT9lbVY.js";import"./mat3-e0AQhzgy.js";import"./mat4f64-CSKppSlJ.js";import"./vec4f64-CCf6w8sj.js";import"./computeTranslationToOriginAndRotation-Xje1tWyk.js";import"./mat4-CSxAPr-6.js";import"./plane-CwsoDe0Y.js";import"./vec2f64-CaE_5U6X.js";import"./ViewingMode-HRfKv6NR.js";function _(c,t,i,n){const{rendererJSON:s,isRGBRenderer:p}=c;let r=null,a=null;if(t&&p)r=t;else if(t&&(s==null?void 0:s.type)==="pointCloudUniqueValueRenderer"){a=R.fromJSON(s);const e=a.colorUniqueValueInfos;r=new Uint8Array(3*n);const f=I(a.fieldTransformType);for(let o=0;o<n;o++){const u=(f?f(t[o]):t[o])+"";for(let l=0;l<e.length;l++)if(e[l].values.includes(u)){r[3*o]=e[l].color.r,r[3*o+1]=e[l].color.g,r[3*o+2]=e[l].color.b;break}}}else if(t&&(s==null?void 0:s.type)==="pointCloudStretchRenderer"){a=U.fromJSON(s);const e=a.stops;r=new Uint8Array(3*n);const f=I(a.fieldTransformType);for(let o=0;o<n;o++){const u=f?f(t[o]):t[o],l=e.length-1;if(u<e[0].value)r[3*o]=e[0].color.r,r[3*o+1]=e[0].color.g,r[3*o+2]=e[0].color.b;else if(u>=e[l].value)r[3*o]=e[l].color.r,r[3*o+1]=e[l].color.g,r[3*o+2]=e[l].color.b;else for(let b=1;b<e.length;b++)if(u<e[b].value){const m=(u-e[b-1].value)/(e[b].value-e[b-1].value);r[3*o]=e[b].color.r*m+e[b-1].color.r*(1-m),r[3*o+1]=e[b].color.g*m+e[b-1].color.g*(1-m),r[3*o+2]=e[b].color.b*m+e[b-1].color.b*(1-m);break}}}else if(t&&(s==null?void 0:s.type)==="pointCloudClassBreaksRenderer"){a=B.fromJSON(s);const e=a.colorClassBreakInfos;r=new Uint8Array(3*n);const f=I(a.fieldTransformType);for(let o=0;o<n;o++){const u=f?f(t[o]):t[o];for(let l=0;l<e.length;l++)if(u>=e[l].minValue&&u<=e[l].maxValue){r[3*o]=e[l].color.r,r[3*o+1]=e[l].color.g,r[3*o+2]=e[l].color.b;break}}}else r=new Uint8Array(3*n).fill(255);if(i&&(a!=null&&a.colorModulation)){const e=a.colorModulation.minValue,f=a.colorModulation.maxValue,o=.3;for(let u=0;u<n;u++){const l=i[u],b=l>=f?1:l<=e?o:o+(1-o)*(l-e)/(f-e);r[3*u]=b*r[3*u],r[3*u+1]=b*r[3*u+1],r[3*u+2]=b*r[3*u+2]}}return r}function E(c,t){if(c.encoding==null||c.encoding===""){const i=J(t,c);if(i.vertexAttributes.position==null)return;const n=N(t,i.vertexAttributes.position),s=i.header.fields,p=[s.offsetX,s.offsetY,s.offsetZ],r=[s.scaleX,s.scaleY,s.scaleZ],a=n.length/3,e=new Float64Array(3*a);for(let f=0;f<a;f++)e[3*f]=n[3*f]*r[0]+p[0],e[3*f+1]=n[3*f+1]*r[1]+p[1],e[3*f+2]=n[3*f+2]*r[2]+p[2];return e}if(c.encoding==="lepcc-xyz")return V(t).result}function h(c,t,i){return c!=null&&c.attributeInfo.useElevation?t?z(t,i):null:c!=null&&c.attributeInfo.storageInfo?q(c.attributeInfo.storageInfo,c.buffer,i):null}function z(c,t){const i=new Float64Array(t);for(let n=0;n<t;n++)i[n]=c[3*n+2];return i}function P(c,t,i,n,s){const p=c.length/3;let r=0;for(let a=0;a<p;a++){let e=!0;for(let f=0;f<n.length&&e;f++){const{filterJSON:o}=n[f],u=s[f].values[a];switch(o.type){case"pointCloudValueFilter":{const l=o.mode==="exclude";o.values.includes(u)===l&&(e=!1);break}case"pointCloudBitfieldFilter":{const l=M(o.requiredSetBits),b=M(o.requiredClearBits);(u&l)===l&&!(u&b)||(e=!1);break}case"pointCloudReturnFilter":{const l=15&u,b=u>>>4&15,m=b>1,$=l===1,g=l===b;let y=!1;for(const d of o.includedReturns)if(d==="last"&&g||d==="firstOfMany"&&$&&m||d==="lastOfMany"&&g&&m||d==="single"&&!m){y=!0;break}y||(e=!1);break}}}e&&(i[r]=a,c[3*r]=c[3*a],c[3*r+1]=c[3*a+1],c[3*r+2]=c[3*a+2],t[3*r]=t[3*a],t[3*r+1]=t[3*a+1],t[3*r+2]=t[3*a+2],r++)}return r}function I(c){switch(c){default:case null:case"none":return t=>t;case"low-four-bit":return t=>15&t;case"high-four-bit":return t=>(240&t)>>4;case"absolute-value":return t=>Math.abs(t);case"modulo-ten":return t=>t%10}}function M(c){let t=0;for(const i of c||[])t|=1<<i;return t}class X{transform(t){const i=this._transform(t),n=[i.points.buffer,i.rgb.buffer];i.pointIdFilterMap!=null&&n.push(i.pointIdFilterMap.buffer);for(const s of i.attributes)"buffer"in s.values&&D(s.values.buffer)&&s.values.buffer!==i.rgb.buffer&&n.push(s.values.buffer);return Promise.resolve({result:i,transferList:n})}_transform(t){const i=E(t.schema,t.geometryBuffer);let n=i.length/3,s=null;const p=new Array,r=h(t.primaryAttributeData,i,n);t.primaryAttributeData!=null&&r&&p.push({attributeInfo:t.primaryAttributeData.attributeInfo,values:r});const a=h(t.modulationAttributeData,i,n);t.modulationAttributeData!=null&&a&&p.push({attributeInfo:t.modulationAttributeData.attributeInfo,values:a});let e=_(t.rendererInfo,r,a,n);if(t.filterInfo&&t.filterInfo.length>0&&t.filterAttributesData!=null){const o=t.filterAttributesData.filter(S).map(u=>{const l=h(u,i,n),b={attributeInfo:u.attributeInfo,values:l};return p.push(b),b});s=new Uint32Array(n),n=P(i,e,s,t.filterInfo,o)}for(const o of t.userAttributesData){const u=h(o,i,n);p.push({attributeInfo:o.attributeInfo,values:u})}3*n<e.length&&(e=new Uint8Array(e.buffer.slice(0,3*n))),this._applyElevationOffsetInPlace(i,n,t.elevationOffset);const f=this._transformCoordinates(i,n,T.fromData(t.obbData),v.fromJSON(t.inSR),v.fromJSON(t.outSR));return{obbData:t.obbData,points:f,rgb:e,attributes:p,pointIdFilterMap:s}}_transformCoordinates(t,i,n,s,p){if(!F(t,s,0,t,p,0,i))throw new Error("Can't reproject");const r=A(n.center),a=w(),e=w(),f=A(n.halfSize);x(O,n.quaternion);const o=new Float32Array(3*i);for(let u=0;u<i;u++){let l=3*u;a[0]=t[l]-r[0],a[1]=t[l+1]-r[1],a[2]=t[l+2]-r[2],C(e,a,O),f[0]=Math.max(f[0],Math.abs(e[0])),f[1]=Math.max(f[1],Math.abs(e[1])),f[2]=Math.max(f[2],Math.abs(e[2])),o[l++]=a[0],o[l++]=a[1],o[l]=a[2]}return n.halfSize=f,o}_applyElevationOffsetInPlace(t,i,n){if(n!==0)for(let s=0;s<i;s++)t[3*s+2]+=n}}const O=k();function ct(){return new X}export{ct as default};
