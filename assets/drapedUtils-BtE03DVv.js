const __vite__fileDeps=["assets/UniqueValueRenderer-7uqoe5qH.js","assets/index-BdlI2FVT.js","assets/index-DQMU5mn_.css","assets/ColorStop-BjodVbhP.js","assets/diffUtils-Cvmld_nE.js","assets/colorRamps-CSdC0saB.js","assets/compilerUtils-vO2blZnn.js","assets/commonProperties-DDhb4E0s.js","assets/styleUtils-DHuQZmH8.js","assets/layerUtils-C0ByrsCg.js"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{c0 as Y,cO as ee,n as te,f as l,y as f,ac as re,ae as ie,N as D,b6 as I,ad as se,g as G,T as k,co as oe,o as T,O as ne,dO as ae,U as le,S as ue,k as pe,H as ye,s as H,e as j,V as ce,q as z,cA as Q,$ as fe,aD as he,be as _,aa as de,a0 as q,fB as me,bL as ge}from"./index-BdlI2FVT.js";import{i as be,o as we}from"./scaleUtils-DaNVMeZM.js";import{n as A}from"./floorFilterUtils-DZ5C6FQv.js";import{R as xe}from"./normalizeUtils-Cik6ve5l.js";import{f as ve,s as $e,n as Se}from"./utils-nisnNviQ.js";import{n as Fe}from"./sublayerUtils-DeEdtjiO.js";import{c as Oe}from"./commonProperties-DDhb4E0s.js";import{n as Re,p as Ee}from"./popupUtils-DVZLIYmh.js";function N(t,e){return e?"xoffset"in e&&e.xoffset?Math.max(t,Math.abs(e.xoffset)):"yoffset"in e&&e.yoffset?Math.max(t,Math.abs(e.yoffset||0)):t:t}function Me(t){let e=0,i=0;for(let o=0;o<t.length;o++){const r=t[o].size;typeof r=="number"&&(e+=r,i++)}return e/i}function J(t,e){var i;return typeof t=="number"?t:(i=t==null?void 0:t.stops)!=null&&i.length?Me(t.stops):e}function Ie(t,e){if(!e)return t;const i=e.filter(s=>s.type==="size").map(s=>{const{maxSize:u,minSize:p}=s;return(J(u,t)+J(p,t))/2});let o=0;const r=i.length;if(r===0)return t;for(let s=0;s<r;s++)o+=i[s];const n=Math.floor(o/r);return Math.max(n,t)}function B(t){var n;const e=t==null?void 0:t.renderer,i=t==null?void 0:t.pointerType,o=i==="touch"?9:6;if(!e)return o;const r="visualVariables"in e?Ie(o,e.visualVariables):o;if(e.type==="simple")return N(r,e.symbol);if(e.type==="unique-value"){let s=r;return(n=e.uniqueValueInfos)==null||n.forEach(u=>{s=N(s,u.symbol)}),s}if(e.type==="class-breaks"){let s=r;return e.classBreakInfos.forEach(u=>{s=N(s,u.symbol)}),s}return e.type==="dot-density"||e.type,r}function je(t,e){const{dpi:i,gdbVersion:o,geometry:r,geometryPrecision:n,height:s,historicMoment:u,layerOption:p,mapExtent:a,maxAllowableOffset:y,returnFieldName:c,returnGeometry:m,returnUnformattedValues:v,returnZ:$,spatialReference:O,timeExtent:d,tolerance:S,width:w}=t.toJSON(),{dynamicLayers:g,layerDefs:b,layerIds:M}=Ne(t),L=(e==null?void 0:e.geometry)!=null?e.geometry:null,x={historicMoment:u,geometryPrecision:n,maxAllowableOffset:y,returnFieldName:c,returnGeometry:m,returnUnformattedValues:v,returnZ:$,tolerance:S},R=L&&L.toJSON()||r;x.imageDisplay=`${w},${s},${i}`,o&&(x.gdbVersion=o),R&&(delete R.spatialReference,x.geometry=JSON.stringify(R),x.geometryType=Y(R));const U=O??(R==null?void 0:R.spatialReference)??(a==null?void 0:a.spatialReference);if(U&&(x.sr=ee(U)),x.time=d?[d.start,d.end].join(","):null,a){const{xmin:W,ymin:C,xmax:K,ymax:X}=a;x.mapExtent=`${W},${C},${K},${X}`}return b&&(x.layerDefs=b),g&&!b&&(x.dynamicLayers=g),x.layers=p==="popup"?"visible":p,M&&!g&&(x.layers+=`:${M.join(",")}`),x}function Ne(t){var $,O;const{mapExtent:e,floors:i,width:o,sublayers:r,layerIds:n,layerOption:s,gdbVersion:u}=t,p=(O=($=r==null?void 0:r.find(d=>d.layer!=null))==null?void 0:$.layer)==null?void 0:O.serviceSublayers,a=s==="popup",y={},c=be({extent:e,width:o,spatialReference:e==null?void 0:e.spatialReference}),m=[],v=d=>{const S=c===0,w=d.minScale===0||c<=d.minScale,g=d.maxScale===0||c>=d.maxScale;if(d.visible&&(S||w&&g))if(d.sublayers)d.sublayers.forEach(v);else{if((n==null?void 0:n.includes(d.id))===!1||a&&(!d.popupTemplate||!d.popupEnabled))return;m.unshift(d)}};if(r==null||r.forEach(v),r&&!m.length)y.layerIds=[];else{const d=Fe(m,p,u),S=m.map(w=>{const g=A(i,w);return w.toExportImageJSON(g)});if(d)y.dynamicLayers=JSON.stringify(S);else{if(r){let g=m.map(({id:b})=>b);n&&(g=g.filter(b=>n.includes(b))),y.layerIds=g}else n!=null&&n.length&&(y.layerIds=n);const w=Pe(i,m);if(w!=null&&w.length){const g={};for(const b of w)b.definitionExpression&&(g[b.id]=b.definitionExpression);Object.keys(g).length&&(y.layerDefs=JSON.stringify(g))}}}return y}function Pe(t,e){const i=!!(t!=null&&t.length),o=e.filter(r=>r.definitionExpression!=null||i&&r.floorInfo!=null);return o.length?o.map(r=>{const n=A(t,r),s=te(n,r.definitionExpression);return{id:r.id,definitionExpression:s??void 0}}):null}var V;let h=V=class extends k{static from(t){return oe(V,t)}constructor(t){super(t),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.historicMoment=null,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}writeHistoricMoment(t,e){e.historicMoment=t&&t.getTime()}};l([f({type:Number,json:{write:!0}})],h.prototype,"dpi",void 0),l([f()],h.prototype,"floors",void 0),l([f({type:String,json:{write:!0}})],h.prototype,"gdbVersion",void 0),l([f({types:re,json:{read:ie,write:!0}})],h.prototype,"geometry",void 0),l([f({type:Number,json:{write:!0}})],h.prototype,"geometryPrecision",void 0),l([f({type:Number,json:{write:!0}})],h.prototype,"height",void 0),l([f({type:Date})],h.prototype,"historicMoment",void 0),l([D("historicMoment")],h.prototype,"writeHistoricMoment",null),l([f({type:[Number],json:{write:!0}})],h.prototype,"layerIds",void 0),l([f({type:["top","visible","all","popup"],json:{write:!0}})],h.prototype,"layerOption",void 0),l([f({type:I,json:{write:!0}})],h.prototype,"mapExtent",void 0),l([f({type:Number,json:{write:!0}})],h.prototype,"maxAllowableOffset",void 0),l([f({type:Boolean,json:{write:!0}})],h.prototype,"returnFieldName",void 0),l([f({type:Boolean,json:{write:!0}})],h.prototype,"returnGeometry",void 0),l([f({type:Boolean,json:{write:!0}})],h.prototype,"returnM",void 0),l([f({type:Boolean,json:{write:!0}})],h.prototype,"returnUnformattedValues",void 0),l([f({type:Boolean,json:{write:!0}})],h.prototype,"returnZ",void 0),l([f({type:se,json:{write:!0}})],h.prototype,"spatialReference",void 0),l([f()],h.prototype,"sublayers",void 0),l([f({type:Oe,json:{write:!0}})],h.prototype,"timeExtent",void 0),l([f({type:Number,json:{write:!0}})],h.prototype,"tolerance",void 0),l([f({type:Number,json:{write:!0}})],h.prototype,"width",void 0),h=V=l([G("esri.rest.support.IdentifyParameters")],h);const Z=h;let F=class extends k{constructor(t){super(t),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(t,e){return T.fromJSON({attributes:{...e.attributes},geometry:{...e.geometry}})}writeFeature(t,e){if(!t)return;const{attributes:i,geometry:o}=t;i&&(e.attributes={...i}),o!=null&&(e.geometry=o.toJSON(),e.geometryType=ae.toJSON(o.type))}};l([f({type:String,json:{write:!0}})],F.prototype,"displayFieldName",void 0),l([f({type:T})],F.prototype,"feature",void 0),l([ne("feature",["attributes","geometry"])],F.prototype,"readFeature",null),l([D("feature")],F.prototype,"writeFeature",null),l([f({type:Number,json:{write:!0}})],F.prototype,"layerId",void 0),l([f({type:String,json:{write:!0}})],F.prototype,"layerName",void 0),F=l([G("esri.rest.support.IdentifyResult")],F);const _e=F;async function Ve(t,e,i){const o=(e=Te(e)).geometry?[e.geometry]:[],r=ve(t);return r.path+="/identify",xe(o).then(n=>{const s=je(e,{geometry:n==null?void 0:n[0]}),u=$e({...r.query,f:"json",...s}),p=Se(u,i);return le(r.path,p).then(Ge).then(a=>Ae(a,e.sublayers))})}function Ge(t){const e=t.data;return e.results=e.results||[],e.exceededTransferLimit=!!e.exceededTransferLimit,e.results=e.results.map(i=>_e.fromJSON(i)),e}function Te(t){return t=Z.from(t)}function Ae(t,e){if(!(e!=null&&e.length))return t;const i=new Map;function o(r){i.set(r.id,r),r.sublayers&&r.sublayers.forEach(o)}e.forEach(o);for(const r of t.results)r.feature.sourceLayer=i.get(r.layerId);return t}let P=null;function Ce(t,e){return e.type==="tile"||e.type==="map-image"}let E=class extends ue{constructor(t){super(t),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=pe(async e=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(e).catch(()=>{}))})}initialize(){const t=e=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(e).catch(()=>{})),this.updateHighlightedFeatures(this._highlightGeometriesResolution)};this.addHandles([ye(()=>this.highlightGraphics,"change",e=>t(e.added),{onListenerAdd:e=>t(e)})])}async fetchPopupFeaturesAtLocation(t,e){var s,u;const{layerView:{layer:i,view:{scale:o}}}=this;if(!t)throw new H("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:i});const r=Le(i.sublayers,o,e);if(!r.length)return[];const n=await He(i,r);if(!((((u=(s=i.capabilities)==null?void 0:s.operations)==null?void 0:u.supportsIdentify)??!0)&&i.version>=10.5)&&!n)throw new H("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:i});return n?this._fetchPopupFeaturesUsingQueries(t,r,e):this._fetchPopupFeaturesUsingIdentify(t,r,e)}clearHighlights(){var t;(t=this.highlightGraphics)==null||t.removeAll()}highlight(t){const e=this.highlightGraphics;if(!e)return j();let i=null;if(t instanceof T?i=[t]:ce.isCollection(t)&&t.length>0?i=t.toArray():Array.isArray(t)&&t.length>0&&(i=t),i=i==null?void 0:i.filter(z),!(i!=null&&i.length))return j();for(const o of i){const r=o.sourceLayer;r!=null&&"geometryType"in r&&r.geometryType==="point"&&(o.visible=!1)}return e.addMany(i),j(()=>e.removeMany(i??[]))}async _updateHighlightedFeaturesSymbols(t){const{layerView:{view:e},highlightGraphics:i,highlightGraphicUpdated:o}=this;if(i&&o)for(const r of t){const n=r.sourceLayer&&"renderer"in r.sourceLayer&&r.sourceLayer.renderer;r.sourceLayer&&"geometryType"in r.sourceLayer&&r.sourceLayer.geometryType==="point"&&n&&"getSymbolAsync"in n&&n.getSymbolAsync(r).then(async s=>{var a;s||(s=new Q);let u=null;const p="visualVariables"in n?(a=n.visualVariables)==null?void 0:a.find(y=>y.type==="size"):void 0;p&&(P||(P=(await fe(async()=>{const{getSize:y}=await import("./UniqueValueRenderer-7uqoe5qH.js").then(c=>c.g);return{getSize:y}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]))).getSize),u=P(p,r,{view:e.type,scale:e.scale,shape:s.type==="simple-marker"?s.style:null})),u||(u="width"in s&&"height"in s&&s.width!=null&&s.height!=null?Math.max(s.width,s.height):"size"in s?s.size:16),i.includes(r)&&(r.symbol=new Q({style:"square",size:u,xoffset:"xoffset"in s?s.xoffset:0,yoffset:"yoffset"in s?s.yoffset:0}),o(r,"symbol"),r.visible=!0)})}}async _updateHighlightedFeaturesGeometries(t){const{layerView:{layer:e,view:i},highlightGraphics:o,highlightGraphicUpdated:r}=this;if(this._highlightGeometriesResolution=t,!r||!(o!=null&&o.length)||!e.capabilities.operations.supportsQuery)return;const n=this._getTargetResolution(t),s=new Map;for(const a of o)if(!this._featuresResolutions.has(a)||this._featuresResolutions.get(a)>n){const y=a.sourceLayer;he(s,y,()=>new Map).set(a.getObjectId(),a)}const u=Array.from(s,([a,y])=>{const c=a.createQuery();return c.objectIds=[...y.keys()],c.outFields=[a.objectIdField],c.returnGeometry=!0,c.maxAllowableOffset=n,c.outSpatialReference=i.spatialReference,a.queryFeatures(c)}),p=await Promise.all(u);if(!this.destroyed)for(const{features:a}of p)for(const y of a){const c=y.sourceLayer,m=s.get(c).get(y.getObjectId());m&&o.includes(m)&&(m.geometry=y.geometry,r(m,"geometry"),this._featuresResolutions.set(m,n))}}_getTargetResolution(t){const e=t*_(this.layerView.view.spatialReference),i=e/16;return i<=10?0:t/e*i}async _fetchPopupFeaturesUsingIdentify(t,e,i){const o=await this._createIdentifyParameters(t,e,i);if(o==null)return[];const{results:r}=await Ve(this.layerView.layer.parsedUrl,o,i);return r.map(n=>n.feature)}async _createIdentifyParameters(t,e,i){const{floors:o,layer:r,timeExtent:n,view:{spatialReference:s,scale:u}}=this.layerView;if(!e.length)return null;await Promise.all(e.map(({sublayer:v})=>v.load(i).catch(()=>{})));const p=Math.min(de("mapservice-popup-identify-max-tolerance"),r.allSublayers.reduce((v,$)=>$.renderer?B({renderer:$.renderer,pointerType:i==null?void 0:i.pointerType}):v,2)),a=this.createFetchPopupFeaturesQueryGeometry(t,p),y=we(u,s),c=Math.round(a.width/y),m=new I({xmin:a.center.x-y*c,ymin:a.center.y-y*c,xmax:a.center.x+y*c,ymax:a.center.y+y*c,spatialReference:a.spatialReference});return new Z({floors:o,gdbVersion:"gdbVersion"in r?r.gdbVersion:void 0,geometry:t,height:c,layerOption:"popup",mapExtent:m,returnGeometry:!0,spatialReference:s,sublayers:r.sublayers,timeExtent:n,tolerance:p,width:c})}async _fetchPopupFeaturesUsingQueries(t,e,i){const{layerView:{floors:o,timeExtent:r}}=this,n=e.map(async({sublayer:s,popupTemplate:u})=>{var g;if(await s.load(i).catch(()=>{}),s.capabilities&&!s.capabilities.operations.supportsQuery)return[];const p=s.createQuery(),a=B({renderer:s.renderer,pointerType:i==null?void 0:i.pointerType}),y=this.createFetchPopupFeaturesQueryGeometry(t,a),c=new Set,[m]=await Promise.all([Re(s,u),(g=s.renderer)==null?void 0:g.collectRequiredFields(c,s.fieldsIndex)]);q(i),me(c,s.fieldsIndex,m);const v=Array.from(c).sort();if(p.geometry=y,p.outFields=v,p.timeExtent=r,o){const b=o.clone(),M=A(b,s);M!=null&&(p.where=p.where?`(${p.where}) AND (${M})`:M)}const $=this._getTargetResolution(y.width/a),O=await Ue(u);q(i);const d=s.geometryType==="point"||O&&O.arcadeUtils.hasGeometryOperations(u);d||(p.maxAllowableOffset=$);let{features:S}=await s.queryFeatures(p,i);const w=d?0:$;S=await ze(s,S,i);for(const b of S)this._featuresResolutions.set(b,w);return S});return(await Promise.allSettled(n)).reduce((s,u)=>u.status==="fulfilled"?[...s,...u.value]:s,[]).filter(z)}};function Le(t,e,i){const o=[];if(!t)return o;const r=n=>{const s=n.minScale===0||e<=n.minScale,u=n.maxScale===0||e>=n.maxScale;if(n.visible&&s&&u){if(n.sublayers)n.sublayers.forEach(r);else if(n.popupEnabled){const p=Ee(n,{...i,defaultPopupTemplateEnabled:!1});p!=null&&o.unshift({sublayer:n,popupTemplate:p})}}};return t.map(r),o}function Ue(t){var e;return(e=t.expressionInfos)!=null&&e.length||Array.isArray(t.content)&&t.content.some(i=>i.type==="expression")?ge():Promise.resolve()}async function He(t,e){var i,o;if((o=(i=t.capabilities)==null?void 0:i.operations)!=null&&o.supportsQuery)return!0;try{return await Promise.any(e.map(({sublayer:r})=>r.load().then(()=>r.capabilities.operations.supportsQuery)))}catch{return!1}}async function ze(t,e,i){const o=t.renderer;return o&&"defaultSymbol"in o&&!o.defaultSymbol&&(e=o.valueExpression?await Promise.all(e.map(r=>o.getSymbolAsync(r,i).then(n=>n?r:null))).then(r=>r.filter(n=>n!=null)):e.filter(r=>o.getSymbol(r)!=null)),e}l([f({constructOnly:!0})],E.prototype,"createFetchPopupFeaturesQueryGeometry",void 0),l([f({constructOnly:!0})],E.prototype,"layerView",void 0),l([f({constructOnly:!0})],E.prototype,"highlightGraphics",void 0),l([f({constructOnly:!0})],E.prototype,"highlightGraphicUpdated",void 0),l([f({constructOnly:!0})],E.prototype,"updatingHandles",void 0),E=l([G("esri.views.layers.support.MapService")],E);function Ke(t,e,i,o=new I){let r=0;if(i.type==="2d")r=e*(i.resolution??0);else if(i.type==="3d"){const y=i.overlayPixelSizeInMapUnits(t),c=i.basemapSpatialReference;r=c==null||c.equals(i.spatialReference)?e*y:_(c)/_(i.spatialReference)}const n=t.x-r,s=t.y-r,u=t.x+r,p=t.y+r,{spatialReference:a}=i;return o.xmin=Math.min(n,u),o.ymin=Math.min(s,p),o.xmax=Math.max(n,u),o.ymax=Math.max(s,p),o.spatialReference=a,o}new I;export{Ce as S,E as U,Ke as r};
